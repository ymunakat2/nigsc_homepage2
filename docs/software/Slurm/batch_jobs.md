---
id: batch_jobs
title: バッチジョブの投入
---

## バッチジョブの投入方法

Slurmではバッチジョブの投入にはsbatchコマンドを利用します。バッチジョブ実行とは、ジョブをスクリプトファイルとして記述し、スクリプトファイルを引数として指定してパーティション（キュー）にジョブを投入し、ジョブの実行後、ジョブの実行結果をファイルに出力させる非同期なジョブ実行方式です。処理を非同期に依頼でき、対話処理が必要無い実行完了までに長時間が必要なジョブ実行の際に利用します。ジョブの実行結果はファイルに出力されます。（オプションでファイル名を指定しない場合は、slurm-ジョブID.outというファイル名で標準出力と標準エラー出力が１ファイルで出力されます）

** sbatch [オプション]　ジョブスクリプトファイル名 **

でジョブを投入します。

sbatchコマンドの主なオプションは以下のようになります。

|オプション|オプションの説明|
|---------|---------------|
|-o  --output パス     |ジョブの標準出力を＜パス＞に出力する|
|-e --error パス|ジョブのエラー出力を＜パス＞に出力する|
|-J ジョブ名| ジョブ名を指定することが可能です。|
|-N --nodes |ジョブに対して割り当てるノード数を指定する|
|-n --ntasks |ジョブに対して割り当てるタスク数。デフォルトでは1つのノードに対して１つのタスクを起動する|
|--exclusive |計算ノードを排他的に利用する(占有する)|
|-p パーティション名 |ジョブを投入したいパーティションを指定する|
|-mem 整数[unit]|ジョブに対して割り当てるメモリ量 unitを省略した場合単位はMBです。|
|--mem-per-cpu 整数[units]|1CPUあたりに確保するメモリ量を指定します。unitを省略した場合単位はMBです。|
|-t --time |実行時間の上限設定 時間指定の仕方の詳細については[sbatch](https://slurm.schedmd.com/sbatch.html)のオンラインマニュアルを参照してください|

また、-o,-eオプションでは以下のパターンが利用可能です。

|パターン |意味|
|--------|----|
|%j |ジョブID|
|%A|ジョブアレイのマスタージョブID|
|%a |Job array(index) ID|
|%J | %j.%a と同じ|
|%u|ユーザ名|
|%x|ジョブ名|


ジョブの実行オプションは、ジョブスクリプトの先頭に指示行として記載して指定することも可能です。実際、オプションで指示すると繰り返し実行する場合は大変な為、通常はこの方式を利用する場合が多いです。シェバンと、シェルスクリプトの最初のコマンド行との間に#SBATCHを行頭につけてオプションを指定します。

記述例
```
#!/bin/sh
#SBATCH -o /home/aaaa/results/%x-%j.out

```



## Slurmの環境変数

ジョブの実行時に、ジョブ内で実行時に変数を参照して処理を制御できるように以下の環境変数がSlurmにより実行環境に設定されます。

|Slurm環境変数名|変数の説明|
|--------------|---------|
|SLURM_CPUS_PER_TASK|-c　で指定したCPUコア数|
|SLURM_GPUS | --gpusで指定したGPU数|
|SLURM_JOB_ID | ジョブID |
|SLURM_JOB_DEPENDENCY | -d に設定した値 |
|SLURM_JOB_NAME | ジョブ名 |
|SLURM_JOB_PARTITION | パーティション名 |
|SLURM_MEM_PER_CPU | --mem-per-cpu で設定したメモリ量 |


## ジョブの状態確認

squeueコマンドを利用してジョブの実行状態を確認することができます。オプションの詳細については[オンラインマニュアル](https://slurm.schedmd.com/squeue.html#SECTION_OPTIONS)を参照してください。

実行例

```
squeue

```

squeueでデフォルトで表示される項目は以下のようになります


|項目名|説明|
|-------|----|
|JOBID|ジョブに割り当てられたジョブIDが表示されます。|
|PARTITION | ジョブが投入されたパーティション(キュー)名を表示します。|
|NAME|ジョブ名（未指定の場合はコマンド文字列）を表示します。|
|USER |ジョブを投入したユーザ名が表示されます。|
|ST|ジョブの状態を表示します。主なジョブの状態を以下の表に示します。|
|TIME|ジョブの実行時間（形式：days-hh:mm:ss）|
|NODES|ジョブ実行に使用されるノード数 |
|NODELIST(REASON)|ジョブが実行されるホスト名のリスト|



## ジョブの詳細情報確認

自分のジョブのより詳細な情報を確認したい場合は、squeueコマンドでジョブＩＤを確認した後に、scontrol show job により確認することができます。オプションの詳細については[オンラインマニュアル](https://slurm.schedmd.com/scontrol.html#SECTION_OPTIONS)を参照してください。

実行例

```
scontrol show job

```

## ジョブの削除

想定した以上に処理に時間がかかっている、ジョブの標準出力、標準エラー出力に出力されている途中結果からジョブが期待した動作をしていないと思われる場合は、scancelコマンドでジョブを削除します。

実行例

```
scancel ジョブID

```

投入した複数のジョブを一括してキャンセルしたい場合は、以下の指定方法が利用可能です。

```

# ユーザ名を指定して削除する場合
scancel -u ユーザID

# パーティション名を指定して削除する場合
scancel -p パーティション名

# ジョブの状態を指定して削除する場合
scancel -t ジョブの状態（ 例：Penting )  

```
オプションの詳細については[オンラインマニュアル](https://slurm.schedmd.com/scancel.html#SECTION_OPTIONS)を参照してください。

## ジョブの実行結果の確認

sacctコマンドでジョブの実行履歴を確認することが可能です。オプションの詳細については[オンラインマニュアル](https://slurm.schedmd.com/sacct.html#SECTION_OPTIONS)を参照してください。


## 各種ジョブの実行方法について

各種ジョブを実行する際のジョブ投入スクリプトの記載方法、指定する指示行について以下に説明します。


### 単体ジョブを実行する場合
ノード間並列でもなく、ノード内並列（スレッド並列）でもないジョブを実行する場合は、ジョブスクリプトに以下のように記述します。

```
#!/bin/bash
#SBATCH -p パーティション名
#SBATCH -n 1　　#ジョブで起動するプロセス数を指定。この場合１


```

### スレッド並列ジョブを実行する場合
１つのプロセスでCPUのコアを複数使用するマルチスレッド実行ジョブは以下のように投入します。


```
!#/bin/bash
#SBATCH -p パーティション名
#SBATCH -n 1               #ジョブで起動するプロセス数を指定。この場合１
#SBATCH -c 20　　　　　　　 # ジョブで使用するCPUコア数を指定する。(ノード内で利用できるCPUコア数を指定)
export OMP_NUM_THREADS=${SLURM_CPUS_PER_TASK}
./a.out
exit $?

```
上記でOMP_NUM_THREADSという環境変数を指定しているのは、a.outがOpenMPを利用して記述されたプログラムである場合、何Coreを利用してスレッド並列でプログラムを実行するか。を指定しています。
またここでCPUのノード内のCPUソケット数、コア数に配慮してスレッド割付を行いたい場合は、以下のオプションを指定してスレッド割付を行います。


|オプション|意味|
|---------|----|
|--ntasks-per-node |１つのノードに割り当てるジョブ内のタスク数|
|--ntasks-per-core |１つのコアに割り当てるジョブ内のタスク数|
|--ntasks-per-socket |1つのソケットに割り当てるジョブ内のタスク数|
|--sockets-per-node |ジョブに割り当てるノードあたりのソケット数 |
|--threads-per-core |1つのコアに割り当てるジョブ内のスレッド数|
|--cores-per-socket|1つのソケット内で割り当てるジョブ内のコア数|

ジョブに割り当てる計算ノード数、１つの計算ノード内のCPUソケット数（遺伝研スパコンのThin計算ノード、GPU計算ノードでは２）、１つの物理CPUがサポートするコア数を考えながら上記のオプションに指定する数値を決定してジョブを投入してください。上記のオプションに指定した数値に整合性がない場合は、ジョブ投入時にエラーとなります。その場合は指定した数値に整合性があるかを見直してください。


### MPIプログラムを実行する場合

遺伝研スパコンでは、OpenMPI、IntelMPIをMPI処理系の実装としてインストールしておりこの２つを利用することになります。slurmではPMIxをサポートしているMPI処理系では、MPI処理系側に同梱されているmpirunコマンドではなくsrunをMPIの起動コマンドとして推奨している為、以下はジョブスクリプト内からsrunを呼び出してMPIプログラムを実行する例について記述します。

- IntelMPIの場合

環境変数として、I_MPI_PMI_LIBRARYを設定して、Slurm PMIライブラリのディレクトリ位置を指定するようにします。
またその他環境については、moduleコマンドで読み込んで設定します。


```
#!/bin/bash
#SBATCH -p
#SBATCH --job-name mpi-test
#SBATCH --nodes=4
#SBATCH --ntasks=8
#SBATCH -o %x.%J.out

export I_MPI_PMI_LIBRARY=/path/to/slurm/lib/libpmi2.so
srun mpi_test

```

- OpenMPIの場合

Slurmのsrunコマンドを利用して直接MPIを起動可能です。以下のようなジョブスクリプトで起動することが可能です。

```

#!/bin/bash
#SBATCH -p
#SBATCH --job-name mpi-test
#SBATCH --nodes=4
#SBATCH --ntasks=8
#SBATCH -o %x.%J.out

module load xxxxx
srun mpi_test

```


上記のように記述すれば、sbatch側でSlurmに必要計算資源を要求してsrunでプロセスを起動していくという動作になります。sbatchで投入したスクリプト内で指示行でオプション指定が記述されていれば、スクリプト内のsrun側にオプション指定は必要ありません。



### GPUを利用するジョブを実行する場合

GPU環境はSlurmのGRES(Generic Resources)を利用して環境定義しています。以下のように必要なGPU数をジョブスクリプト内で要求してジョブを投入します。

```
#!/bin/bash
#SBATCH --gres=gpu:4
・・・・
```

--gres では、以下のようにリソースを指定します。

--gres=name:[type]:count

ここでnameはGeneric Resource名で、gpuを指定します。また遺伝研スパコンのGPUノードでは、Volta(v100)のGPUを４基搭載しています。
typeはv100を指定します。またcountは使用したいGPU数を指定します。例えば、１GPU計算ノード上で、volta100 GPUを4基利用したい
場合は、

--gres:gpu:v100:4   または   --gres:gpu:4

と指定します。

その他、主なオプションについては以下のようなものがあります。

|オプション|意味|
|---------|-----|
|--gpus | ジョブあたりに割り当てるGPU数を指定|
|--gpus-per-node |1ノードあたりでそのジョブに割り当てるGPU数|
|--gpus-per-socket|1 CPUソケットあたりで割り当てるGPU数|
|--cpus-per-gpu |1GPUあたりに割り当てるCPUコア数 |
|--mem-per-gpu| 1GPUあたりに割り当てられるメモリ量|

詳細な動作を指定することは可能ですが、整合性が保てないとエラーになりますので、--gresで使用するGPU数を指定する程度にとどめ、あとはSlurmに任せてください。
オプションの詳細については、[Generic Resource(GRES) Scheduleing](https://slurm.schedmd.com/gres.html) の記述を参照してください。





