---
id: batch_jobs
title: バッチジョブ
---

## バッチジョブの使い方

CPU コアを 1 コアだけ使用し長時間実行するプログラムを少数実行する場合は、バッチジョブとして実行してください。Slurmではバッチジョブの投入にはsbatchコマンドを利用します。

例えば以下のようなシェルスクリプト(example.sh)を実行したいとします。（このシェルスクリプトは遺伝研スパコンにインストールされている biotools Singularity コンテナのリストを生成します。）

```
#!/bin/bash

ls /usr/local/biotools > $1
```

以下のようなjob_script.sh を用意し、sbatch job_script.shを実行して下さい。 すると Slurmの待ち行列（partition）にバッチジョブが投入されます。ジョブ投入スクリプトの中の#SBATCHが書いてある行は、Slurmへのオプション指示行です。

```
#!/bin/bash
#SBATCH -p short 
#SBATCH -t 0-00:10:00
#SBATCH --mem-per-cpu 4g
#SBATCH -J an_example

example.sh biotools_list.txt
```

- Slurmの場合、AGEの動作と異なり、デフォルト動作として、batchコマンドを実行した際のカレントワーキングディレクトリを投入したジョブのカレントワーキングディレクトリとしてジョブを実行します。その他のディレクトリでジョブを実行したい場合は、--chdirオプションを利用して指定してください。
- Slurmの場合、AGEの動作と異なり、sbatch実行時のシェルの環境変数をジョブの起動シェルにデフォルト動作で全て引き継ぎます。特定の環境変数のみを引き継ぎたい（引き継ぎたくない）場合は、--exportオプションを利用してください。詳細についてはオンラインマニュアルを参照してください。
- -p short : バッチジョブを投入する待ち行列(パーティション Partition)の種類を指定します。
  - 個人ゲノム解析区画の場合は構成によります。特に何も指定しなければデフォルト動作としてはallキューに投入されます。
- -t 0-00:10:00 : バッチジョブの実行上限時間。
  - バッチジョブの実行開始からこの実行上限時間をすぎるとバッチジョブは強制終了させられます。
  - 実行時間の上限は少し長めに書いたほうが安全ですが、長すぎるとスケジューリングが難しくジョブが実行されにくくなる場合があります。その場合は--time-minと組み合わせての指定を検討してください。
  - -t の指定省略時は、パーティションの設定が適用されます。
  - 時刻の記述フォーマットは、minutes, minutes:seconds,hours:minutes:seconds,days-hours,days-hours:minutes,days-hours:minutes:secondsがあります。
- --mem-per-cpuは、使用するメモリ量です。ジョブに割り当てられたCPUコア（タスク）1個あたりに割り当てられるメモリ量を指定していることになります。単位は G,M,K が使えます。省略時は単位はMとして解釈されます。ジョブ全体としては、ジョブに割り当てられたコア数×指定したメモリ量が割り当てられることになるので注意してください。
- -J : ジョブ名の指定です。

sbatchコマンドの主なオプションは以下のようになります。その他のオプション指定については開発元のオンラインマニュアルを参照してください。

- [sbatchコマンドのオンラインマニュアル](https://slurm.schedmd.com/sbatch.html)



## SBATCHコマンドの主なオプション

|オプション|オプションの説明|
|---------|---------------|
|-o  --output パス |ジョブの標準出力を＜パス＞に出力する|
|-e --error パス|ジョブのエラー出力を＜パス＞に出力する|
|-J ジョブ名| ジョブ名を指定することが可能です。|
|-N --nodes |ジョブに対して割り当てるノード数を指定する|
|-n --ntasks |ジョブに対して割り当てるタスク数。デフォルトでは1つのノードに対して１つのタスクを起動する|
|--exclusive |計算ノードを排他的に利用する(占有する)|
|-t 時間 |ジョブの実行時間の上限指定.時刻の記述フォーマットは、minutes、minutes:seconds、hours:minutes:seconds、days-hours、days-hours:minutes、days-hours:minutes:secondsがある。 |
|--time-min 時間　|ジョブの実行時間の上限の最低限の時間を指定。-tと合わせて指定されている場合、-tで指定された上限時間を、--time-minで指定された時間まで下げてスケジューリングできる場合、ジョブがサブミットされる。時間指定のフォーマットは-tと同じ|
|-p パーティション名 |ジョブを投入したいパーティションを指定する。省略した場合はデフォルトパーティションにジョブは投入される|
|-mem 整数[unit]|ジョブに対して割り当てるメモリ量 unitを省略した場合単位はMB。|
|--mem-per-cpu 整数[units]|1CPUあたりに確保するメモリ量を指定。unitを省略した場合単位はMB。|
|--chdir /  -D |ジョブのワーキングディレクトリを、オプションで指定したディレクトリにする。デフォルトはsbatch,srunコマンドを投入した際のカレントワーキングディレクトリがジョブのワーキングディレクトリになる|
|--reservation=リザベーション名|ジョブに対して、予め取得済みのリソースリザベーションを割り当てる|


また、-o,-eオプションではファイル名の指定に以下のパターンが利用可能です。

|パターン |意味|
|--------|----|
|%j |ジョブID|
|%A|ジョブアレイのマスタージョブID|
|%a |Job array(index) ID|
|%J | %j.%a と同じ|
|%u|ユーザ名|
|%x|ジョブ名|


## Slurmの環境変数

ジョブの実行時に、Slurmによりジョブの実行環境に環境変数が設定されます。以下に主なSLURM環境変数を示します。

[sbatch実行時に設定されるSLURM環境変数(オンラインマニュアル)](https://slurm.schedmd.com/sbatch.html#SECTION_OUTPUT-ENVIRONMENT-VARIABLES)


#### 主なSLURM環境変数 ####
|Slurm環境変数名|変数の説明|
|--------------|---------|
|SLURM_CPUS_PER_TASK|-c　で指定したCPUコア数|
|SLURM_JOB_ID | ジョブID |
|SLURM_JOB_DEPENDENCY | -d に設定した値 |
|SLURM_JOB_NAME | ジョブ名 |
|SLURM_JOB_PARTITION | パーティション名 |
|SLURM_MEM_PER_CPU | --mem-per-cpu で設定したメモリ量 |








