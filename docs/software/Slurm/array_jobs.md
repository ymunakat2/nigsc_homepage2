---
id: array_jobs
title: アレイジョブ
---

## アレイジョブとは

同じ計算処理を数百、数千回繰り返して行うといった処理を実行したい場合、アレイジョブ機能を利用してください。ジョブ管理システムに与えるジョブスケジューリングの為の計算負荷を大幅に低減することができる為、ジョブ管理システムの全体負荷が軽減されます。またユーザにとっても実行結果の管理の手間を低減し、ジョブスクリプトの記述容易性を向上することが可能です。

多数回のジョブをそのまま投入しようとしないでください。システムに過負荷を与える場合があります。

#### 参考情報

開発元の以下のページにアレイジョブについての詳細が記述されていますので、参照してください。

- [Slurm Job Array Support(開発元)](https://slurm.schedmd.com/job_array.html)

## アレイジョブの実行方法

アレイジョブの実行にはsbatchコマンドのオプション -a を使用します。

　　　-a [n]-[m]:s

整数nから整数mまでの間でステップ数sだけ増加させてタスクを起動します。sは省略可能で省略した場合1刻みでタスクが起動されます。例えば

    -a 1-10:2

と指定すれば、タスクIDとしてはステップ数2刻みで、1,3,5,7,9 が指定されて、5個のタスクが実行されます。5個のタスクは計算リソースに空きがあれば並行して実行される為、処理時間の短縮にもつながります。
また、タスクの同時実行数を一定数に制限したい場合は、

    -a 1-100%10

と書けば、たとえ計算資源の空きがあっても、10個までしかタスクが同時実行されないようにすることが可能です。%表記はステップ数の記述と合わせて利用することが可能です。例えば、

    -a 1-100:4%5

と表記すれば、1から100までで、4刻みで、5つのタスクを同時に実行していくことを指示したことになります。この指定の場合は、

1,5,9,13,17 　21,25,29,33,37 ......

というかたちで処理が実行されます。


また、誤ったユーザ指定で大量のタスクを一挙に実行しない為、システム側で最大の並行ジョブ実行数を設定しています。その数値(MaxArraySize)については以下のように入力すれば確認することが可能です。MaxArraySizeを超えた数値を指定しても有効にはなりませんのでその点は注意してください。

```
scontrol show config | grep MaxArraySize
MaxArraySize    = 上限値

```

ジョブスクリプト内でのアレイジョブの記載例としては以下のようにします。(あくまで例です)

```
#!/bin/bash
#SBATCH -a 0-2:1
#SBATCH --job-name=jarray-example
#SBATCH -o out/array_%A_%a.out
#SBATCH -e err/array_%A_%a.err

```

アレイジョブを投入したときに利用可能な環境変数は以下になります。

### アレイジョブで利用するSlurm環境変数について

アレイジョブ内から参照可能な環境変数は以下のとおりです。

|環境変数　 |  概要 |
|---------|-------|
|SLURM_ARRAY_JOB_ID | アレイジョブのジョブID|
|SLURM_ARRAY_TASK_ID | アレイジョブのタスクID |
|SLURM_ARRAY_TASK_COUNT | アレイジョブのタスク数 |
| SLURM_ARRAY_TASK_MIN | アレイジョブの最初のタスクID |
|SLURM_ARRAY_TASK_MAX |アレイジョブの最後のタスクID |


アレイジョブは、SLURM_ARRAY_JOB_IDが一つ、SLURM_ARRAY_TASK_IDが各タスクに割り振られることになります。なのでアレイジョブ全体を指定したい場合にはアレイジョブIDを指定してコマンドを投入し、その中の１タスクを指定したい場合はアレイジョブID_タスクIDと指定することになります。これらの環境変数を利用してジョブスクリプト内で制御処理を記述することになります。
バイオ系の典型的な使用例としては、ユーザの実行したいコマンドがmyappであって、これに与える入力ファイルを切り替えてデータ処理させたい。タスク間には依存関係がない。などという使用例があると思います。この場合、ジョブスクリプト例としては以下のように書きます。

```
#!/bin/bash
#SBATCH -a 1-10

./myapp input_${SLURM_ARRAY_TASK_ID}.data

```
上記の場合、入力ファイルが、input_1.data,input_2.data,input_3.data,input_4.data,input_5.dataと5つあり、そのファイル名をmpprogというユーザプログラムにパラメータとして渡して処理させる。という場合の例になります。5つのファイルの処理を逐次、またはループで記述することはなく、５つのタスクとしてSlurmに投入され、システムリソース条件が合致していれば５つが並行に実行されます。


### ジョブの依存関係を利用した処理方法について

Slurm では-d または --dependency オプションを指定することでジョブの依存関係を定義することが可能であり、これとアレイジョブの機能を併用して簡易ワークフロー的な処理を実行することが可能です。
ジョブの依存関係の単純な例としてここではjob1.shとjob2.shという二つのジョブスクリプトがあり、job1.shの実行完了後に、job2.shを実行するという処理を実現したい場合、例としては以下のように記述することができます。

```
#!/bin/bash

# まず、１番目のジョブを投入する
# Slurmは、"Submitted batch job <jobid>
#
jobstring=$(sbatch job1.sh)
jobid=${jobstring##* }
sbatch --dependency=afterany:${jobid} job2.sh

```
このように記述、起動することで、ジョブの実行順序を定義することができます。ジョブの依存関係定義はSlurmでは以下の場合を定義することが可能です。

|依存関係のタイプ|動作、意味|
|---------------|---------|
|after   |オプションで指定したジョブが開始されたらオペランドで指定したジョブが起動される |
|afterany|オプションで指定したジョブが終了したらオペランドで指定したジョブが起動される||
|afterok |オプションで指定した先行ジョブがすべて成功で終了した場合に後続ジョブは起動される |
|afternotok |オプションで指定した先行ジョブが失敗で終了した場合に後続ジョブは起動される |
|aftercorr |先行ジョブも後続ジョブもアレイジョブの場合、先行ジョブの１タスクが正常終了したとき、後続ジョブの同じタスクＩＤのタスクを実行|
|singleton |指定したジョブは、同じジョブ名のジョブが実行されておらず、同一ユーザのジョブが流れていない場合に後続ジョブが起動される。 |


