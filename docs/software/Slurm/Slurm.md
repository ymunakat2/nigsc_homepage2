---
id: Slurm
title: Slurm の概要
---

遺伝研スパコンでは、個人ゲノム解析区画用のジョブ管理システムとして従来AGE(Altia Grid Engine)に加えSlurm（Simple Linux Utility for Resource Management）を選択可能としています。
Slurmは元々の開発元である米国LLNL(ローレンスリバモア国立研究所)を始めとして全世界の数多くの大規模クラスタ型スパコンシステムで利用実績があるオープンソースソフトウェアのジョブ管理システムで、パブリッククラウドHPC利用向けのジョブ管理システムとしても現在利用可能となっており、ジョブ管理システムとして広く使われています。

AGEとSlurmは基本的な機能では類似な部分が多いのですが、用語、概念の差異、コマンド体系の差異などはありますので、以下にご紹介します。

## Slurmの用語・概念の説明

### ジョブとは

ジョブとはユーザがジョブ管理システム(Slurm)に処理を依頼して、ジョブ管理システムからCPUやメモリなどの計算資源を割り当てられる際の処理実行の単位です。ジョブ管理システム(Slurm)からジョブにはシステム内では一意なIDが割り当てられ、IDを元にしてジョブの実行状況をジョブ管理システム(Slurm)に問い合わせることができます。ジョブの概念自体はAGEとSlurmはほぼ同一です。

### パーティションとは

Slurmは計算サーバ等の計算資源の集合体に対してパーティションと呼ばれる管理の為の論理単位をシステム目的に合わせて定義しています。システム運用者は、パーティション毎に、割り当て可能な計算リソースや実行時間の上限、投入可能な同時実行可能ジョブ数の上限を設定することによって、多数のユーザで共有する計算ノード群の有効活用を図ります。またユーザは、パーティションを利用することにより、システムの稼働状況詳細を自分で確認しなくてもジョブ実行をSlurm(ジョブ管理システム)に任せることが可能になります。
AGEでは、キュー(queue)と呼ばれる論理単位で管理しますが、Slurmではこれをパーティション(partition)と呼んでいます。この二つはほぼ同一の概念を指していると考えてください。

個人ゲノム解析区画では、以下のパーティション（キュー）をシステム側で定義、設定しています。

|パーティション名|最大実行時間|ユーザ毎の最大投入ジョブ数|ユーザ毎の最大使用可能Core数|ユーザ事の最大使用可能メモリ量|
|---------|---------------|---------|-------|-------|
|         |               |

ジョブの投入時に投入パーティションを指定しない場合のデフォルトパーティションは？になります。また計算資源要求をオプションで何も指定しなかった場合、ジョブは以下の設定でSlurmに登録されます。

|要求資源項目|デフォルト|変更する場合のオプション|備考|
|-----------|---------|----------------------|---|
|             |       |                      |   |

### ジョブ投入スクリプトとは

ジョブとしてSlrumに処理を依頼する際に、ユーザは依頼したい処理をスクリプトとして記載してこれをSlurmに渡します。ジョブスクリプトの中にはSlurmのオプションを記載しておくことが可能であり、また実行時にSlurmから渡されるSlurm環境変数によって処理を制御することが可能です。ジョブ投入スクリプトの記載の仕方については、[バッチジョブの投入](/software/Slurm/batch_jobs.md)に記載します。

### Slurmでのマルチコア・マルチスレッド動作の理解に必要な用語定義について

マルチスレッドプログラム、MPI並列プログラムをシステムに投入する場合に用語の理解が必要なことがある為、以下にSlurmで用いる用語の定義について記述します。

|用語| 定義・説明|
|----------|-------|
| LDom | Locality domain または NUMA Domain。遺伝研スパコンの場合はLDom=socketと考えてください。|
|タスク |スレッド動作の説明時にはジョブと同義に使われますが、アレイジョブの説明時にはジョブから起動される子ジョブをタスクと呼ぶ場合があります|
| Socket | システムの設定により異なりますが、Socketは遺伝研スパコンのThin計算ノードでは2と考えてください。|
|CPU | オプション指定でのSlurm用語の中では、CPUは物理CPUを表すのではなくCPU=コアと考えてください。 |
| コア |オプション指定でのSlurm用語の中では、CPUは物理CPUを表すのではなくCPU=コアと考えてください。 |
|スレッド |実行単位。HyperThreading動作が無効な場合は数値としてはスレッド=コアとなる。遺伝研スパコンではスレッド=コア|



## ジョブ実行の流れ

個人ゲノム解析区画でのSlurmをジョブ管理システムとして利用したジョブ実行の流れは概略以下のようになります。

1. 個人ゲノム解析区画のゲートウェイからsshで計算ノードのログインノードか、又はGPU用Slurmログインノードにログインする。
2. 投入用のジョブ投入スクリプトをログインノード上で作成する。
3. ログインノードからsbatchコマンドを利用してジョブをパーティションに投入する。
4. 各種のSlurmコマンドを使用してジョブの実行状態を観察する。
5. ジョブの実行状態が期待通りであれば、ジョブの終了まで待つ。ジョブの実行状態が期待通りでなければscancelコマンド等でジョブ実行を中断させる。エラー出力ファイルの内容を確認しながらジョブスクリプトをデバッグして、修正したジョブ投入スクリプトを用いてsbatchコマンドでジョブを再投入する。
6. ジョブが正常完了したら、出力ファイルから実行結果を確認する。


## 基本的操作の紹介

基本的操作の詳細については、以下の各ページでご説明します。

- [バッチジョブの投入](software/Slurm/batch_jobs.md)
- [インタラクティブジョブの投入](/software/Slurm/interactive_jobs)
- [アレイジョブの投入](/software/Slurm/array_jobs)

## AGE/Slurmコマンド簡易対比表

AGEとSlurmの利用目的別の基本的なコマンド対比表を示します。

| コマンド| AGE|Slurm|Slurmのオンラインマニュアル記述|
|--------|-----|----|----|
|ジョブの投入| qsub ジョブファイル名 | sbatch ジョブファイル名 |[sbatch](https://slurm.schedmd.com/sbatch.html)  |
|ジョブのキャンセル| qdel ジョブID | scancel ジョブID|[scancel](https://slurm.schedmd.com/scancel.html)   |
|キューの状態表示|qstat |squeue| [squeue](https://slurm.schedmd.com/squeue.html)  |
|ジョブのホールド|qhold ジョブID|scontrol hold ジョブID|[scontrol](https://slurm.schedmd.com/scontrol.html)    |
|キュー・パーティションのリスト表示|qconf -sql | scontrol show partition | [scontrol](https://slurm.schedmd.com/scontrol.html)   |
|ノードのリスト表示| qhost |scontrol show nodes |[scontrol](https://slurm.schedmd.com/scontrol.html)    |
|クラスタの状態表示|qhost -q | sinfo | [sinfo](https://slurm.schedmd.com/sinfo.html)   |

各コマンドのオプション指定詳細はまた異なりますので、詳しくはオンラインマニュアルか、現在の開発元である米国SchedMD社のドキュメントサイトを参照してください。

- Slurmのクイックスタートガイド https://slurm.schedmd.com/quickstart.html
- Slurmのコマンドのサマリ表　https://slurm.schedmd.com/pdfs/summary.pdf
- 各ジョブ管理システムの比較 https://slurm.schedmd.com/rosetta.pdf


### GPUの利用環境について

SlurmではGRES(Generic RESources)と呼ぶ機能があり、遺伝研スパコンではGPU環境はこれを用いて設定しています。どの計算ノードがGPUを何枚搭載しているかは以下のコマンドで参照することが可能です。

```
sinfo --Node --Format=NodeHost,Gres,Used


```
SlurmのGPU管理については使用するプラグインによって指定の仕方が異なる場合があります。遺伝研スパコンではGRESを利用したGPUスケジューリングを設定しています。


















